{% extends "base.html" %}

{% block title %}Add Transaction{% endblock title %}
{% block addtransaction %}active{% endblock addtransaction %}
{% block backButton %}<a href="/" class="btn btn-outline-primary me-5"> &#8249; Back</a>{% endblock backButton %}



{% block content %}

<script>

    function delete_prefill(id) {
        document.getElementById(id).style.display = 'block';
    }

    function fillvalues(id, totalAmount) {
        document.getElementById('previousPaycheckModal').style.display='none';

        let table = document.getElementById(id);
        let list = [];
        for (let r = 1; r < table.rows.length - 1; r++) {
            let name = table.rows[r].cells[0].innerHTML;
            let id = table.rows[r].cells[1].id;
            let amount = table.rows[r].cells[1].innerHTML;
            let temp = [name + id, amount];
            list[list.length] = temp;
        }

        for (let i = 0; i < list.length; i++) {
            let input = document.getElementById(list[i][0]);
            // console.log(input);
            input.value = list[i][1];
        }

        let isPercentage = document.getElementById('isPercentage').value === "True";
        if (isPercentage) {
            checkPaycheckPercentage();
        }
        else {
            document.getElementById('paycheck_amount').value = totalAmount;
            checkPaycheck();
        }
    }

    function openPreviousPaycheckModal() {
        document.getElementById('previousPaycheckModal').style.display = 'block';
    }

    function checkPaycheck() {
        let amountValid = false;
        let nameValid = false;
        let submitBtn = document.getElementById('paycheckBtn');
        submitBtn.disabled = true;

        let name = document.getElementById('paycheckName').value;
        console.log(name);
        let total = document.getElementById('paycheck_amount').value;
        console.log(total);
        // prefillBudgets(total);
        if (total !== null) {
            let budgets = document.getElementsByClassName('all-budgets');
            let b_total = 0;
            for (let i = 0; i < budgets.length; i++) {
                b_total += Number(budgets[i].value);
            }
            total = parseFloat(total).toFixed(2);
            b_total = parseFloat(b_total).toFixed(2);
            console.log(total);
            console.log(b_total);

            if (b_total == total) {
                submitBtn.disabled = false;
                let total_error = document.getElementById('amount_error');
                total_error.classList.add('display-none');
                amountValid = true;
            }
            else {
                console.log('here');
                submitBtn.disabled = true;
                let total_error = document.getElementById('amount_error');
                total_error.innerHTML = `Paycheck Amount ($${total}) does not equal combined budget amount ($${b_total}).`;
                total_error.classList.remove('display-none');
            }
        }
        if (name === null || name === '') {
            // show error
            console.log('here');
            submitBtn.disabled = true;
            let name_error = document.getElementById('name_error');
            name_error.classList.remove('display-none');
        }
        else {
            let name_error = document.getElementById('name_error');
            name_error.classList.add('display-none');
            nameValid = true;
        }

        if (nameValid && amountValid) {
            submitBtn.disabled = false;
        }
    }

    function checkPaycheckPercentage() {
        let amountValid = false;
        let nameValid = false;
        let submitBtn = document.getElementById('paycheckBtn');
        submitBtn.disabled = true;

        let name = document.getElementById('paycheckName').value;
        let paycheckAmount = document.getElementById('paycheck_amount').value;
        console.log(name);
        let total = 100;
        console.log(total);
        // prefillBudgets(total);
        if (total !== null) {
            let budgets = document.getElementsByClassName('all-budgets');
            let b_total = 0;
            for (let b of budgets) {
                let temp = Number(b.value);
                b_total += temp;
                let p = b.parentElement.parentElement.querySelector("p");
                p.innerHTML = "$" + Number(paycheckAmount).toFixed(2) * temp / 100;
            }
            total = parseFloat(total).toFixed(2);
            b_total = parseFloat(b_total).toFixed(2);
            console.log(total);
            console.log(b_total);

            if (b_total == total) {
                submitBtn.disabled = false;
                let total_error = document.getElementById('amount_error');
                total_error.classList.add('display-none');
                amountValid = true;
            }
            else {
                console.log('here');
                submitBtn.disabled = true;
                let total_error = document.getElementById('amount_error');
                total_error.innerHTML = `Budgets breakdown (${b_total}%) does not add up too 100%.`;
                total_error.classList.remove('display-none');
            }
        }
        if (name === null || name === '') {
            // show error
            console.log('here');
            submitBtn.disabled = true;
            let name_error = document.getElementById('name_error');
            name_error.classList.remove('display-none');
        }
        else {
            let name_error = document.getElementById('name_error');
            name_error.classList.add('display-none');
            nameValid = true;
        }

        if (nameValid && amountValid) {
            submitBtn.disabled = false;
        }
    }

    function toggleBudgetBreakdown() {
        let isPercentage = document.getElementById('isPercentage');
        let budgets = document.getElementsByClassName('all-budgets');
        let budgetsLi = document.getElementsByClassName('all-budgets-li');

        if (isPercentage.value === "True") {
            isPercentage.value = "";
            document.getElementById("paycheckName").addEventListener("input", checkPaycheck);
            document.getElementById("paycheck_amount").addEventListener("input", checkPaycheck);
            for (let b of budgets) {
                b.addEventListener("input", checkPaycheck);
                b.placeholder = "$0.00";
            }
            for (let b of budgetsLi) {
                let p = b.querySelector("p");
                p.classList.add('display-none');
            }
            checkPaycheck();
        }
        else {
            isPercentage.value = "True";
            document.getElementById("paycheckName").addEventListener("input", checkPaycheckPercentage);
            document.getElementById("paycheck_amount").addEventListener("input", checkPaycheckPercentage);
            for (let b of budgets) {
                b.addEventListener("input", checkPaycheckPercentage);
                b.placeholder = "0.00%";
            }
            for (let b of budgetsLi) {
                let p = b.querySelector("p");
                p.classList.remove('display-none');
            }
            checkPaycheckPercentage();
        }

        let accordionItems = document.getElementsByClassName('accordion-item');
        for (let item of accordionItems) {
            if (item.classList.contains('display-none')) {
                item.classList.remove('display-none');
            }
            else {
                item.classList.add('display-none');
            }
        }
    }

</script>
<div class="container py-5 h-100">
    <div class="card bg-dark text-white border-0">

        <div class="row">
            <div class="col-lg-5 hidden-on-smaller-992">
                <img src="/static/images/money-large.png" class="img-fluid rounded-start img-full" alt="Money image">
            </div>
            <div class="col-lg-7">
                <div class="card-body p-5">
                    <p class="card-title fs-2 mb-3">Add paycheck</p>
                    <form action="{{ url_for('home.paycheck') }}" method="POST">
                        <div class="row">
                            <div class="col-sm">
                                <div class="form-outline form-white mb-4">
                                    <label class="form-label" for="name">Paycheck Name</label>
                                    <input class="validatePaycheck form-control" type="text" id="paycheckName" name="name" placeholder="I'm rich!" autocomplete="niklas" required>
                                </div>
                                <div class="form-outline form-white mb-4">
                                    <label class="form-label" for="amount">Paycheck Amount</label>
                                    <input class="validatePaycheck form-control" type="number" step=".01" id="paycheck_amount" name="amount" placeholder="$0.00" autocomplete="niklas" required>
                                </div>
                                <div class="form-outline form-white mb-4">
                                    <label class="form-label" for="amount">Date</label>
                                    <input class="form-control w-160" type="date" id="date" name="date" required>
                                </div>
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" value="" id="isPercentage" name="isPercentage" onclick="toggleBudgetBreakdown()">
                                    <label class="form-check-label" for="isPercentage">
                                        Use percentages for breakdown
                                    </label>
                                </div>
                                <div class="form-outline form-white mb-4">
                                    <!-- <label class="form-label" for="amount"><h4>Paycheck Amount</h4></label>
                                    <input class="validatePaycheck form-control" type="text" id="paycheck_amount" name="amount" placeholder="Paycheck Amount" required> -->
                                    {% if showPrefills %}
                                        <button type="button" class="btn btn-outline-primary text-wrap" onclick="openPreviousPaycheckModal()">Copy amounts from previous paycheck</button>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-sm">
                                <label class="form-label" for="existing_courses">Existing Budgets</label>
                                <ul name="existing_courses" class="list-group better-scroll" id="style-1" style="max-height: 400px;overflow-y: scroll;">
                                    {% for budget in budgets %}
                                        <li class="list-group-item all-budgets-li">
                                            <div class="row">
                                                <div class="col">
                                                    <label class="form-label fs-6" for="{{ budget.name }}{{ budget.id }}">{{ budget.name }}</label>
                                                </div>
                                            </div>
                                            <div class="row">
                                                <div class="col-8">
                                                    <input class="validatePaycheck all-budgets form-control mw-160 px-3" type="number" step=".01" id="{{ budget.name }}{{ budget.id }}" name="{{ budget.name }}{{ budget.id }}" placeholder="$0.00" autocomplete="niklas">
                                                </div>
                                                <div class="col-4">
                                                    <p class="display-none mt-2 mb-0" id="{{ budget.id }}_amount"></p>
                                                </div>
                                            </div>
                                        </li>
                                    {% endfor %}
                                </ul>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-sm mt-5">
                                <p id="name_error" class="text-danger display-none">Paycheck Name is invalid<br></p>
                                <p id="amount_error" class="text-danger display-none"><br></p>
                                <input id="paycheckBtn" class="btn btn-primary " type="submit" value="Add Transaction" disabled>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>


{% if showPrefills %}
    <div id="previousPaycheckModal" class="modal" style="display: none;">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Copy Previous Paycheck Amounts ?</h5>
                    <button onclick="document.getElementById('previousPaycheckModal').style.display='none'" type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="accordion" id="accordionExample">
                        {% for i, (k, v) in enumerate(prefills.items()) %}
                            <div class="accordion-item{% if k == 100.0 %} display-none{% endif %}">
                                <h2 class="accordion-header" id="heading{{ i }}">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ i }}" aria-expanded="true" aria-controls="collapse{{ i }}">
                                        Total Amount: {{ k }}
                                    </button>
                                </h2>
                                <div id="collapse{{ i }}" class="accordion-collapse collapse" aria-labelledby="heading{{ i }}" data-bs-parent="#accordionExample">
                                    <div class="accordion-body">
                                        <table id="table{{ i }}" class="table table-secondary">
                                            <thead>
                                                <tr class="table-secondary">
                                                    <th scope="col">Budget Name</th>
                                                    <th scope="col">Amount</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for budget in v %}
                                                    <tr class="table-secondary">
                                                        <td>{{ budget[1] }}</td>
                                                        <td id={{ budget[0] }}>{{ budget[2] }}</td>
                                                    </tr>
                                                {% endfor %}
                                                <tr>
                                            </tbody>
                                        </table>
                                        <div class="row justify-content-between">
                                            <div class="col-auto me-auto">
                                                <button onclick="delete_prefill('delete{{ k }}')" class="btn btn-outline-danger">Delete</button>
                                            </div>
                                            <div class="col-auto ">
                                                <button onclick="fillvalues('table{{ i }}', {{ k }});" class="btn btn-primary">Select this previous amount</button>
                                            </div>
                                        </div>
                                        <!-- <button onclick="fillvalues('table{{ i }}', {{ k }});" class="btn btn-primary">Select this previous amount</button>
                                        <button onclick="fillvalues('table{{ i }}', {{ k }});" class="btn btn-outline-danger">Delete</button> -->
                                    </div>
                                </div>
                            </div>

                            <div id="delete{{ k }}" class="modal" style="display: none;">
                                <div class="modal-dialog">
                                    <div class="modal-content">
                                        <form method="POST" action="{{ url_for('home.delete_prefill', amount=k) }}">
                                            <div class="modal-header">
                                                <h5 class="modal-title">Delete prefill amount {{ k }} ?</h5>
                                                <button onclick="document.getElementById('delete{{ k }}').style.display='none'" type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                            </div>
                                            <div class="modal-body">
                                                <p>Are you sure you want to delete this prefill?</p>
                                            </div>
                                            <div class="modal-footer">
                                                <button type="submit" id="delete_button" class="btn btn-danger">Delete</button>
                                                <button onclick="document.getElementById('delete{{ k }}').style.display='none'" type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal" aria-label="Close">Cancel</button>
                                            </div>
                        
                                        </form>
                        
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>
                <div class="modal-footer">
                        <button onclick="document.getElementById('previousPaycheckModal').style.display='none'" type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal" aria-label="Close">Cancel</button>
                </div>
            </div>
        </div>
    </div>

{% endif %}

            
            

    <script>
        document.getElementById("paycheckName").addEventListener("input", checkPaycheck);
        document.getElementById("paycheck_amount").addEventListener("input", checkPaycheck);

        {% for budget in budgets %}
            document.getElementById("{{ budget.name }}{{ budget.id }}".replace("&#39;", "'")).addEventListener("input", checkPaycheck);
        {% endfor %}

        let date = new Date();
        let ele = document.getElementById('date');
        let year = date.getFullYear();
        let month = (date.getMonth() + 1).toString().padStart(2, '0');
        let day = date.getDate().toString().padStart(2, '0');
        let strDate = year + '-' + month + '-' + day;
        ele.valueAsDate = date;
        ele.value = strDate;
    </script>

{% endblock content %}
