{% extends "base.html" %}

{% block title %}Add Transaction{% endblock title %}
{% block addtransaction %}active{% endblock addtransaction %}
{% block backButton %}<a href="/" class="btn btn-outline-primary me-5"> &#8249; Back</a>{% endblock backButton %}



{% block content %}

<script src="/static/js/addpaycheckHelpers.js"></script>
<script>
    function sendRequest(url) {
        return new Promise(function (resolve, reject) {
            var xmlHttp = new XMLHttpRequest();
            xmlHttp.open("GET", url);
            xmlHttp.onload = () => {
                resolve(xmlHttp.response);
            };
            xmlHttp.send(null);

        })
    }

</script>
    <div class="card border-0">
        <div class="row">
            <div class="col-lg-5 hidden-on-smaller-992">
                <img src="/static/images/money-large.png" class="img-fluid rounded-start img-full" alt="Money image" loading="lazy">
            </div>
            <div class="col-lg-7">
                <div class="card-body p-5">
                    <p class="card-title fs-2 mb-3">Add paycheck</p>
                    <form action="{{ url_for('home.paycheck') }}" method="POST">
                        <div class="row">
                            <div class="col-sm">
                                <div class="form-outline mb-4">
                                    <label class="form-label" for="name">Paycheck Name</label>
                                    <input class="validatePaycheck form-control" type="text" id="paycheckName" name="name" placeholder="I'm rich!" autocomplete="niklas" required>
                                    <div id="name_error" class="invalid-feedback">
                                        Please enter a name for the paycheck.
                                    </div>
                                </div>
                                <div class="form-outline mb-4">
                                    <label class="form-label" for="amount">Paycheck Amount</label>
                                    <input class="validatePaycheck form-control" type="number" step=".01" id="paycheck_amount" name="amount" placeholder="$0.00" autocomplete="niklas" required>
                                    <div id="amount_error" class="invalid-feedback">
                                    </div>
                                </div>
                                <div class="form-outline mb-4">
                                    <label class="form-label" for="amount">Date</label>
                                    <input class="form-control w-160" type="date" id="date" name="date" required>
                                </div>
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" value="" id="isPercentage" name="isPercentage" onclick="toggleBudgetBreakdown()">
                                    <label class="form-check-label" for="isPercentage">
                                        Use percentages for breakdown
                                    </label>
                                </div>
                                <div class="form-outline mb-4">
                                    <!-- <label class="form-label" for="amount"><h4>Paycheck Amount</h4></label>
                                    <input class="validatePaycheck form-control" type="text" id="paycheck_amount" name="amount" placeholder="Paycheck Amount" required> -->
                                    {% if showPrefills %}
                                        <button type="button" class="btn btn-outline-primary text-wrap w-100" onclick="openPreviousPaycheckModal()">Copy amounts from previous paycheck</button>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-sm">
                                <label class="form-label" for="existing_courses">Budgets</label>
                                <ul name="existing_courses" class="list-group better-scroll border" id="style-1" style="max-height: 400px;overflow-y: scroll;">
                                    {% for budget in budgets %}
                                        <li class="list-group-item all-budgets-li">
                                            <div class="row">
                                                <div class="col">
                                                    <label class="form-label fs-6" for="{{ budget.name }}{{ budget.id }}">{{ budget.name }}</label>
                                                </div>
                                            </div>
                                            <div class="row">
                                                <div class="col-8">
                                                    <input class="validatePaycheck all-budgets form-control mw-160 px-3" type="number" step=".01" id="{{ budget.name }}{{ budget.id }}" name="{{ budget.name }}{{ budget.id }}" placeholder="$0.00" autocomplete="niklas">
                                                </div>
                                                <div class="col-4">
                                                    <p class="display-none mt-2 mb-0" id="{{ budget.id }}_amount"></p>
                                                </div>
                                            </div>
                                        </li>
                                    {% endfor %}
                                </ul>
                            </div>
                        </div>
                        <div class="row">
                            <div class="mt-5">
                                <button id="paycheckBtn" class="btn btn-primary w-100" type="submit" disabled>Add paycheck</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>


{% if showPrefills %}
    <div id="previousPaycheckModal" class="modal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Copy Previous Paycheck Amounts ?</h5>
                    <button onclick="document.getElementById('previousPaycheckModal').style.display='none'" type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="accordion" id="accordionExample">
                        {% for i, (k, v) in enumerate(prefills.items()) %}
                            <div id="prefill{{ k }}" class="accordion-item{% if k == 100.0 %} display-none{% endif %}">
                                <h2 class="accordion-header" id="heading{{ i }}">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ i }}" aria-expanded="true" aria-controls="collapse{{ i }}">
                                        Total Amount: {{ k }}
                                    </button>
                                </h2>
                                <div id="collapse{{ i }}" class="accordion-collapse collapse" aria-labelledby="heading{{ i }}" data-bs-parent="#accordionExample">
                                    <div class="accordion-body">
                                        <table id="table{{ i }}" class="table">
                                            <thead>
                                                <tr>
                                                    <th scope="col">Budget Name</th>
                                                    <th scope="col">Amount</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for budget in v %}
                                                    <tr>
                                                        <td>{{ budget[1] }}</td>
                                                        <td id={{ budget[0] }}>{{ budget[2] }}</td>
                                                    </tr>
                                                {% endfor %}
                                                <tr>
                                            </tbody>
                                        </table>
                                        <div class="row">
                                            <div class="col-5 p-1">
                                                <button onclick="openDeletePrefillModa('delete{{ k }}')" class="btn btn-outline-danger w-100">Delete</button>
                                            </div>
                                            <div class="col-7 p-1">
                                                <button onclick="fillBudgetAmountsFromPrefill('table{{ i }}', {{ k }});" class="btn btn-primary w-100">Select this previous amount</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div id="delete{{ k }}" class="modal">
                                <div class="modal-dialog">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h5 class="modal-title">Delete prefill amount {{ k }} ?</h5>
                                            <button onclick="document.getElementById('delete{{ k }}').style.display='none'" type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                        </div>
                                        <div class="modal-body">
                                            <p>Are you sure you want to delete this prefill?</p>
                                        </div>
                                        <div class="modal-footer">
                                            <button onclick="sendDeletePrefillRequest(event, 'delete{{ k }}', '{{ k }}', '{{ url_for('home.delete_prefill', amount=k) }}')" type="button" id="delete_button" class="btn btn-danger">
                                                <span class="value">Delete</span>
                                                <span class="spinner spinner-border spinner-border-sm" role="status" aria-hidden="true" hidden></span>
                                                <span class="loading" hidden>Loading...</span>
                                            </button>
                                            <button onclick="document.getElementById('delete{{ k }}').style.display='none'" type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal" aria-label="Close">Cancel</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>
                <div class="modal-footer">
                    <button onclick="document.getElementById('previousPaycheckModal').style.display='none'" type="button" class="btn btn-secondary w-100" data-bs-dismiss="modal" aria-label="Close">Cancel</button>
                </div>
            </div>
        </div>
    </div>

{% endif %}

    <script src="/static/js/setdate.js"></script>
    <script>
        document.getElementById("paycheckName").addEventListener("input", isPaycheckValid);
        document.getElementById("paycheck_amount").addEventListener("input", isPaycheckValid);

        {% for budget in budgets %}
            document.getElementById("{{ budget.name }}{{ budget.id }}".replace("&#39;", "'")).addEventListener("input", isPaycheckValid);
        {% endfor %}
    </script>

{% endblock content %}
